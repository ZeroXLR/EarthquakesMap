<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Recent Earthquake Markers</title>
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
		}

		#map {
			height: 100%;
		}
	</style>
	<link rel="icon" type="image/ico" href="images/quakecon.ico"/>
</head>

<body>
	<div id="map"></div>
	<script type="text/javascript">
		'use strict';
		var GLOBALFUNCTIONS = (function MapEngine(global) {
			var document = global.document;
			var storage = global.sessionStorage;
			var console = global.console;

			var gm_authFailure = (function KeyManager() {
				var mapsURLWithKey = storage.getItem('MapsURLWithGoogleMapsBrowserKey');

				// call this block of code asynchronously to make sure that it executes AFTER MapEngine() function returns
				global.setTimeout(function() {
					var key;
					if (mapsURLWithKey) {
						makeScript();
					} else if ((key = global.prompt("Type in your Google Maps API key please!"))) {
						mapsURLWithKey = "https://maps.googleapis.com/maps/api/js?key=" + key + "&callback=initializeMap";
						makeScript();
						storage.setItem('MapsURLWithGoogleMapsBrowserKey', mapsURLWithKey);
					} else {
						alert("No browser key provided. DIE.");
						throw new Error("Use of Google Maps API without key is deprecated");
					}
				}, 0);

				function makeScript() {
					var script = document.createElement("script");
					script.type = 'text/javascript';
					script.src = mapsURLWithKey;
					// "https://maps.googleapis.com/maps/api/js?callback=initializeMap";
					document.body.appendChild(script);
				}

				function gm_authFailure() {
					storage.removeItem('MapsURLWithGoogleMapsBrowserKey');
					// storage.removeItem('MainPreferredLocation');
					global.alert('DEATH BY AUTHENTICATION FAILURE\n\nLook at the browser console for details\n\nTRY REFRESHING AND ENTER A VALID KEY');
				};

				return gm_authFailure;
			})();

			// function deletemarkers() {
			// 	var i, len = markers.length;
			// 	for (i = 0; i < len; ++i) {
			// 		markers[i].setMap(null);
			// 	}
			// 	markers = [];
			// }
			var initializeMap = (function MapManipulators() {
				var maps; // won't be defined until initializeMap() is called
				var locationObject = JSON.parse(storage.getItem('MainPreferredLocation')) || {
					hasBeenStored: false,
					location: {
						lat: 51.4778,
						lng: -0.0014
					}
				};
				var map;
				var mainMarker;

				function initializeMap() {
					maps = google.maps; // google.maps is now defined
					// we unfortunately need a new map everytime; you cannot rebind an existing map to the new div element that would be created upon reload
					createNewMap();
					locationObject.hasBeenStored || setOwnLocation();
					fetchQuakesData();
				}

				// map initialization factory
				function createNewMap() {
					map = new maps.Map(document.getElementById("map"), {
						zoom: 3,
						center: locationObject.location
					});
					mainMarker = new maps.Marker({
						position: locationObject.location,
						map: map,
						icon: 'images/catcon.ico',
						title: 'Royal Observatory at Greenwich',
						animation: maps.Animation.DROP
					});
				}

				var geolocation = global.navigator.geolocation;
				function setOwnLocation() {
					if (geolocation && global.confirm('Do you want to set your location?')) {
						geolocation.getCurrentPosition(
							function(position) {
								var coords = position.coords;
								var location = {
									lat: coords.latitude,
									lng: coords.longitude
								};
								map.setCenter(location);
								mainMarker.setPosition(location);
								mainMarker.setAnimation(maps.Animation.DROP);
								mainMarker.setTitle('You!');
								storage.setItem('MainPreferredLocation', JSON.stringify({
									hasBeenStored: true,
									location: location
								}));
							},
							function(error) {
								console.error('ERROR(' + error.code + '): ' + error.message);
								alert(error.message + '\n\nDEFAULTING TO THE ROYAL OBSERVATORY AT GREENWICH');
								locationObject.hasBeenStored = true;
								storage.setItem('MainPreferredLocation', JSON.stringify(locationObject));
							},
							{
								enableHighAccuracy: true,
								timeout: 120000,
								maximumAge: 0
							}
						);
					} else {
						console.warn("Your browser doesn't support geolocation. No worries; defaulting to the Royal Observatory at Greenwich.");
						locationObject.hasBeenStored = true;
						storage.setItem('MainPreferredLocation', JSON.stringify(locationObject));
					}
				}

				var quakesURL = 'http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson'; // var markers = [];
				function fetchQuakesData() {
					var xhr = new XMLHttpRequest();
					xhr.onreadystatechange = function() {
						if (xhr.readyState === 4 && xhr.status === 200) {
							// if (markers.length) {
							// 	deletemarkers();
							// }
							var recentQuakes = JSON.parse(xhr.responseText).features;
							var quake, numberOfQuakes = recentQuakes.length; // var marker;
							for (var i = 0; i < numberOfQuakes; ++i) {
								quake = recentQuakes[i]; // marker =
								new maps.Marker({
									position: {
										lat: quake.geometry.coordinates[1],
										lng: quake.geometry.coordinates[0]
									},
									map: map,
									icon: 'images/quakecon.ico',
									title: quake.properties.title
								}); // markers.push(marker);
							}
						}
						console.log('Earthquake Data Request is at state ' + xhr.readyState + ' and the current HTTP status is ' + xhr.status);
					};
					xhr.open('GET', quakesURL, true);
					xhr.send();
				}

				return initializeMap;
			})();

			return {
				initializeMap: initializeMap,
				gm_authFailure: gm_authFailure
			};
		})(this);

		var initializeMap = GLOBALFUNCTIONS.initializeMap;
		var gm_authFailure = GLOBALFUNCTIONS.gm_authFailure;
	</script>
</body>

</html>
