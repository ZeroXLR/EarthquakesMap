<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Recent Earthquake Markers</title>
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
		}

		#map {
			height: 100%;
		}
	</style>
	<link rel="icon" type="image/ico" href="images/quakecon.ico"/>
</head>

<body>
	<div id="map"></div>
	<script type="text/javascript">
		'use strict';
		var globalfunctions = (function main(global) {
			var doc = global.document;
			var storage = global.sessionStorage;
			var console = global.console;
			// var markers = [];


			var gm_authFailure = (function keymanager() {
				var mapsurlwithkey = storage.getItem('MapsURLWithGoogleMapsBrowserKey');

				// call this block of code asynchronously to make sure that it executes AFTER main() function returns
				global.setTimeout(function() {
					var key;
					if (mapsurlwithkey) {
						makescript();
					} else if ((key = global.prompt("Type in your Google Maps API key please!"))) {
						mapsurlwithkey = "https://maps.googleapis.com/maps/api/js?key=" + key + "&callback=initMap";
						makescript();
						storage.setItem('MapsURLWithGoogleMapsBrowserKey', mapsurlwithkey);
					} else {
						alert("No browser key provided. DIE.");
						throw new Error("Use of Google Maps API without key is deprecated");
					}
				}, 0);

				function makescript() {
					var script = doc.createElement("script");
					script.type = 'text/javascript';
					script.src = mapsurlwithkey;
					// "https://maps.googleapis.com/maps/api/js?callback=initMap";
					doc.body.appendChild(script);
				}

				function gm_authFailure() {
					storage.removeItem('MapsURLWithGoogleMapsBrowserKey');
					// storage.removeItem('MainPreferredLocation');
					global.alert('DEATH BY AUTHENTICATION FAILURE\n\nLook at the browser console for details\n\nTRY REFRESHING AND ENTER A VALID KEY');
				};

				return gm_authFailure;
			})();

			// function deletemarkers() {
			// 	var i, len = markers.length;
			// 	for (i = 0; i < len; ++i) {
			// 		markers[i].setMap(null);
			// 	}
			// 	markers = [];
			// }
			var initMap = (function mapmanipulators() {
				var maps; // won't be defined until initMap() is called
				var locationobject = JSON.parse(storage.getItem('MainPreferredLocation')) || {
					hasbeenstored: false,
					location: {
						lat: 51.4778,
						lng: -0.0014
					}
				};
				var map;
				var mainmarker;

				function initMap() {
					maps = google.maps; // google.maps is now defined
					// we unfortunately need a new map everytime; you cannot rebind an existing map to the new div element that would be created upon reload
					createnewmap();
					locationobject.hasbeenstored || setownlocation();
					fetchquakesdata();
				}

				// map initialization factory
				function createnewmap() {
					map = new maps.Map(doc.getElementById("map"), {
						zoom: 3,
						center: locationobject.location
					});
					mainmarker = new maps.Marker({
						position: locationobject.location,
						map: map,
						icon: 'images/catcon.ico',
						title: 'Royal Observatory at Greenwich',
						animation: maps.Animation.DROP
					});
				}

				var geolocation = global.navigator.geolocation;
				function setownlocation() {
					if (geolocation && global.confirm('Do you want to set your location?')) {
						geolocation.getCurrentPosition(
							function(position) {
								var coords = position.coords;
								var location = {
									lat: coords.latitude,
									lng: coords.longitude
								};
								map.setCenter(location);
								mainmarker.setPosition(location);
								mainmarker.setAnimation(maps.Animation.DROP);
								mainmarker.setTitle('You!');
								storage.setItem('MainPreferredLocation', JSON.stringify({
									hasbeenstored: true,
									location: location
								}));
							},
							function(error) {
								console.error('ERROR(' + error.code + '): ' + error.message);
								alert(error.message + '\n\nDEFAULTING TO THE ROYAL OBSERVATORY AT GREENWICH');
								locationobject.hasbeenstored = true;
								storage.setItem('MainPreferredLocation', JSON.stringify(locationobject));
							},
							{
								enableHighAccuracy: true,
								timeout: 120000,
								maximumAge: 0
							}
						);
					} else {
						console.warn("Your browser doesn't support geolocation. No worries; defaulting to the Royal Observatory at Greenwich.");
						locationobject.hasbeenstored = true;
						storage.setItem('MainPreferredLocation', JSON.stringify(locationobject));
					}
				}

				var quakesurl = 'http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson';
				function fetchquakesdata() {
					var xhr = new XMLHttpRequest();
					xhr.onreadystatechange = function() {
						if (xhr.readyState === 4 && xhr.status === 200) {
							// if (markers.length) {
							// 	deletemarkers();
							// }
							var recentquakes = JSON.parse(xhr.responseText).features;
							var quake, numberofquakes = recentquakes.length; // var marker;
							for (var i = 0; i < numberofquakes; ++i) {
								quake = recentquakes[i]; // marker =
								new maps.Marker({
									position: {
										lat: quake.geometry.coordinates[1],
										lng: quake.geometry.coordinates[0]
									},
									map: map,
									icon: 'images/quakecon.ico',
									title: quake.properties.title
								}); // markers.push(marker);
							}
						}
						console.log('Earthquake Data Request is at state ' + xhr.readyState + ' and the current HTTP status is ' + xhr.status);
					};
					xhr.open('GET', quakesurl, true);
					xhr.send();
				}

				return initMap;
			})();

			return {
				initMap: initMap,
				gm_authFailure: gm_authFailure
			};
		})(this);

		var initMap = globalfunctions.initMap;
		var gm_authFailure = globalfunctions.gm_authFailure;
	</script>
</body>

</html>
